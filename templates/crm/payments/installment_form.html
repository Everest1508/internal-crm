{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}
  {% if installment %}Edit Payment Installment{% else %}Add Payment Installment{% endif %}
{% endblock title %}

{% block content %}
  <div class="container-fluid py-4">
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header pb-0">
            <h6>
              {% if installment %}Edit Payment Installment{% else %}Add Payment Installment{% endif %}
            </h6>
          </div>
          <div class="card-body">
            <form method="post">
              {% csrf_token %}
              
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="project" class="form-control-label">Project *</label>
                    <select class="form-control" id="project" name="project" required onchange="updateProjectDetails()">
                      <option value="">Select a project</option>
                      {% for project in projects %}
                        <option value="{{ project.id }}" 
                                data-budget="{{ project.budget|default:0 }}"
                                data-title="{{ project.title }}"
                                data-client="{{ project.client.name }}"
                                {% if selected_project and selected_project.id == project.id %}selected{% endif %}>
                          {{ project.title }} - {{ project.client.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="title" class="form-control-label">Payment Title *</label>
                    <input type="text" class="form-control" id="title" name="title" required
                           value="{% if installment %}{{ installment.title }}{% endif %}"
                           placeholder="e.g., Milestone 1, Final Payment">
                  </div>
                </div>
              </div>
              
              <!-- Project Financial Details -->
              <div id="project-details" class="row mb-3" style="display: none;">
                <div class="col-12">
                  <div class="alert alert-info">
                    <div class="row">
                      <div class="col-md-3">
                        <strong>Project Budget:</strong><br>
                        <span id="budget-display" class="text-primary">₹0</span>
                      </div>
                      <div class="col-md-3">
                        <strong>Total Paid:</strong><br>
                        <span id="paid-display" class="text-success">₹0</span>
                      </div>
                      <div class="col-md-3">
                        <strong>Remaining:</strong><br>
                        <span id="remaining-display" class="text-warning">₹0</span>
                      </div>
                      <div class="col-md-3">
                        <strong>Max Amount:</strong><br>
                        <span id="max-amount-display" class="text-info">₹0</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="amount" class="form-control-label">Amount (₹) *</label>
                    <input type="number" class="form-control" id="amount" name="amount" 
                           step="0.01" min="0" required
                           value="{% if installment %}{{ installment.amount }}{% endif %}"
                           placeholder="Enter amount">
                    <small class="form-text text-muted">Cannot exceed remaining budget</small>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="payment_type" class="form-control-label">Payment Type *</label>
                    <select class="form-control" id="payment_type" name="payment_type" required>
                      {% for value, label in payment_types %}
                        <option value="{{ value }}" {% if installment and installment.payment_type == value %}selected{% endif %}>
                          {{ label }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="due_date" class="form-control-label">Due Date *</label>
                    <input type="date" class="form-control" id="due_date" name="due_date" required
                           value="{% if installment %}{{ installment.due_date|date:'Y-m-d' }}{% endif %}">
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="notes" class="form-control-label">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                              placeholder="Additional notes about this payment">{% if installment %}{{ installment.notes }}{% endif %}</textarea>
                  </div>
                </div>
              </div>
              
              <div class="d-flex justify-content-end">
                <a href="/crm/payments/" class="btn btn-secondary me-2">Cancel</a>
                <button type="submit" class="btn bg-gradient-primary">
                  {% if installment %}Update{% else %}Create{% endif %} Installment
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  function updateProjectDetails() {
    const projectSelect = document.getElementById('project');
    const projectDetails = document.getElementById('project-details');
    const selectedOption = projectSelect.options[projectSelect.selectedIndex];
    
    if (projectSelect.value) {
      const projectId = projectSelect.value;
      const budget = parseFloat(selectedOption.dataset.budget) || 0;
      
      // Show project details
      projectDetails.style.display = 'block';
      
      // Make AJAX call to get real-time financial data
      fetch(`/crm/project/${projectId}/financial-data/`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('budget-display').textContent = '₹' + data.budget.toLocaleString();
          document.getElementById('paid-display').textContent = '₹' + data.total_paid.toLocaleString();
          document.getElementById('remaining-display').textContent = '₹' + data.remaining_amount.toLocaleString();
          document.getElementById('max-amount-display').textContent = '₹' + data.max_amount.toLocaleString();
          
          // Update amount field max value
          document.getElementById('amount').max = data.max_amount;
          
          // Show warning if remaining amount is low
          if (data.remaining_amount <= 0) {
            document.getElementById('max-amount-display').className = 'text-danger';
            document.getElementById('max-amount-display').textContent = '₹0 (Budget Exhausted)';
          } else if (data.remaining_amount < data.budget * 0.2) {
            document.getElementById('max-amount-display').className = 'text-warning';
          }
        })
        .catch(error => {
          console.error('Error fetching project data:', error);
          // Fallback to basic display
          document.getElementById('budget-display').textContent = '₹' + budget.toLocaleString();
          document.getElementById('paid-display').textContent = '₹0';
          document.getElementById('remaining-display').textContent = '₹' + budget.toLocaleString();
          document.getElementById('max-amount-display').textContent = '₹' + budget.toLocaleString();
        });
    } else {
      projectDetails.style.display = 'none';
    }
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateProjectDetails();
  });
  </script>
{% endblock content %}
