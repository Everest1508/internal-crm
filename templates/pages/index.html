{% extends "layouts/base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid py-4">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-lg-8">
              <h2 class="text-dark mb-2">Welcome to CRM Dashboard</h2>
              <p class="text-muted mb-0">Manage your clients, projects, and track your business growth</p>
            </div>
            <div class="col-lg-4 text-end">
              <div class="icon icon-shape bg-light shadow-sm text-center border-radius-2xl">
                <i class="ni ni-chart-bar-32 text-dark text-gradient text-lg" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row">
    <div class="col-lg-3 col-md-6 col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-3 position-relative">
          <div class="row">
            <div class="col-8 text-start">
              <div class="icon icon-shape bg-light shadow-sm text-center border-radius-2xl">
                <i class="ni ni-circle-08 text-dark text-gradient text-lg" aria-hidden="true"></i>
              </div>
              <h5 class="text-dark font-weight-bolder mb-0 mt-3">
                {{ total_clients|default:"0" }}
              </h5>
              <span class="text-muted text-sm">Total Clients</span>
            </div>
            <div class="col-4 text-end">
              <a href="{% url 'crm:client_list' %}" class="btn btn-sm btn-outline-secondary border">View All</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-3 position-relative">
          <div class="row">
            <div class="col-8 text-start">
              <div class="icon icon-shape bg-light shadow-sm text-center border-radius-2xl">
                <i class="ni ni-chart-bar-32 text-dark text-gradient text-lg" aria-hidden="true"></i>
              </div>
              <h5 class="text-dark font-weight-bolder mb-0 mt-3">
                {{ total_projects|default:"0" }}
              </h5>
              <span class="text-muted text-sm">Active Projects</span>
            </div>
            <div class="col-4 text-end">
              <a href="{% url 'crm:project_list' %}" class="btn btn-sm btn-outline-secondary border">View All</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-3 position-relative">
          <div class="row">
            <div class="col-8 text-start">
              <div class="icon icon-shape bg-light shadow-sm text-center border-radius-2xl">
                <i class="ni ni-money-coins text-dark text-gradient text-lg" aria-hidden="true"></i>
              </div>
              <h5 class="text-dark font-weight-bolder mb-0 mt-3">
                ₹{{ total_income|default:"0"|floatformat:0 }}
              </h5>
              <span class="text-muted text-sm">Total Income (All Time)</span>
            </div>
            <div class="col-4 text-end">
              <span class="badge bg-light text-dark border">Total Income</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-3 position-relative">
          <div class="row">
            <div class="col-8 text-start">
              <div class="icon icon-shape bg-light shadow-sm text-center border-radius-2xl">
                <i class="ni ni-time-alarm text-dark text-gradient text-lg" aria-hidden="true"></i>
              </div>
              <h5 class="text-dark font-weight-bolder mb-0 mt-3">
                {{ pending_projects|default:"0" }}
              </h5>
              <span class="text-muted text-sm">Pending Projects</span>
            </div>
            <div class="col-4 text-end">
              <span class="badge bg-light text-dark border">Attention</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts and Recent Projects Row -->
  <div class="row">
    <!-- Income Chart -->
    <div class="col-lg-8 col-12 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header pb-0 p-3 border-bottom">
          <div class="row">
            <div class="col-6">
              <h6 class="mb-0 text-dark">Monthly Income</h6>
            </div>
            <div class="col-6 text-end">
              <a class="btn btn-link text-dark px-3 mb-0" href="javascript:;">
                <i class="fas fa-pencil text-xs me-1"></i>View Details
              </a>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="income-chart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Project Status -->
    <div class="col-lg-4 col-12 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header pb-0 p-3 border-bottom">
          <h6 class="mb-0 text-dark">Project Status</h6>
        </div>
        <div class="card-body pb-0 p-3">
          <ul class="list-group list-group-flush">
            <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
              <div class="w-100">
                <div class="d-flex mb-2">
                  <span class="me-2 text-sm font-weight-bold text-dark">Completed</span>
                  <span class="ms-auto text-sm font-weight-bold">{{ completed_projects|default:"0" }}</span>
                </div>
                <div>
                  <div class="progress progress-md">
                    <div class="progress-bar bg-success w-{{ completed_percentage|default:25 }}" role="progressbar"></div>
                  </div>
                </div>
              </div>
            </li>
            <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
              <div class="w-100">
                <div class="d-flex mb-2">
                  <span class="me-2 text-sm font-weight-bold text-dark">In Progress</span>
                  <span class="ms-auto text-sm font-weight-bold">{{ in_progress_projects|default:"0" }}</span>
                </div>
                <div>
                  <div class="progress progress-md">
                    <div class="progress-bar bg-info w-{{ in_progress_percentage|default:40 }}" role="progressbar"></div>
                  </div>
                </div>
              </div>
            </li>
            <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
              <div class="w-100">
                <div class="d-flex mb-2">
                  <span class="me-2 text-sm font-weight-bold text-dark">Pending</span>
                  <span class="ms-auto text-sm font-weight-bold">{{ pending_projects|default:"0" }}</span>
                </div>
                <div>
                  <div class="progress progress-md">
                    <div class="progress-bar bg-warning w-{{ pending_percentage|default:35 }}" role="progressbar"></div>
                  </div>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Projects and Quick Actions -->
  <div class="row">
    <!-- Recent Projects -->
    <div class="col-lg-8 col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header pb-0 p-3 border-bottom">
          <div class="row">
            <div class="col-6">
              <h6 class="mb-0 text-dark">Recent Projects</h6>
            </div>
            <div class="col-6 text-end">
              <a class="btn btn-link text-dark px-3 mb-0" href="/crm/projects/">
                <i class="fas fa-list text-xs me-1"></i>View All
              </a>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          {% if recent_projects %}
            <div class="table-responsive">
              <table class="table align-items-center mb-0">
                <thead>
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Project</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Client</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Status</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Due Date</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Progress</th>
                  </tr>
                </thead>
                <tbody>
                  {% for project in recent_projects %}
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0 text-sm text-dark">{{ project.title|truncatechars:30 }}</h6>
                          <p class="text-xs text-secondary mb-0">{{ project.description|truncatechars:50 }}</p>
                        </div>
                      </div>
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0 text-dark">{{ project.client.name }}</p>
                    </td>
                    <td>
                      <span class="badge badge-sm bg-light text-dark border">
                        {{ project.get_status_display }}
                      </span>
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0 text-dark">{{ project.due_date|date:"M d, Y" }}</p>
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <span class="me-2 text-xs font-weight-bold text-dark">{{ project.progress|default:0 }}%</span>
                        <div>
                          <div class="progress">
                            <div class="progress-bar bg-secondary" role="progressbar" aria-valuenow="{{ project.progress|default:0 }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ project.progress|default:0 }}%"></div>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="ni ni-chart-bar-32 text-secondary text-gradient text-lg opacity-10 mb-3" style="font-size: 3rem;"></i>
              <h6 class="text-secondary mb-2">No projects yet</h6>
              <p class="text-secondary mb-3">Start by creating your first project</p>
              <a href="/crm/projects/create/" class="btn btn-secondary btn-sm border">
                <i class="fas fa-plus me-2"></i>Create Project
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-4 col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header pb-0 p-3 border-bottom">
          <h6 class="mb-0 text-dark">Quick Actions</h6>
        </div>
        <div class="card-body p-3">
          <div class="d-grid gap-3">
            <a href="/crm/clients/create/" class="btn btn-outline-secondary btn-lg border">
              <i class="fas fa-user-plus me-2"></i>Add New Client
            </a>
            <a href="/crm/projects/create/" class="btn btn-outline-secondary btn-lg border">
              <i class="fas fa-project-diagram me-2"></i>Create New Project
            </a>
            <a href="/crm/payments/create/" class="btn btn-outline-secondary btn-lg border">
              <i class="fas fa-credit-card me-2"></i>Add Payment
            </a>
            <a href="/crm/payments/" class="btn btn-outline-secondary btn-lg border">
              <i class="fas fa-money-bill me-2"></i>Payment Installments
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Installments Row -->
  <div class="row">
    <!-- Recent Payments -->
    <div class="col-lg-6 col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header pb-0 p-3 border-bottom">
          <div class="row">
            <div class="col-6">
              <h6 class="mb-0 text-dark">Recent Payments</h6>
            </div>
            <div class="col-6 text-end">
              <a class="btn btn-link text-dark px-3 mb-0" href="/crm/payments/">
                <i class="fas fa-list text-xs me-1"></i>View All
              </a>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          {% if recent_payments %}
            <div class="table-responsive">
              <table class="table align-items-center mb-0">
                <thead>
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Project</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Client</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Amount</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Paid Date</th>
                  </tr>
                </thead>
                <tbody>
                  {% for payment in recent_payments %}
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0 text-sm text-dark">{{ payment.project.title|truncatechars:25 }}</h6>
                        </div>
                      </div>
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0 text-dark">{{ payment.project.client.name }}</p>
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0 text-success">₹{{ payment.amount }}</p>
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0 text-dark">{{ payment.paid_date|date:"M d, Y" }}</p>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="ni ni-money-coins text-secondary text-gradient text-lg opacity-10 mb-3" style="font-size: 3rem;"></i>
              <h6 class="text-secondary mb-2">No payments yet</h6>
              <p class="text-secondary mb-3">Start by creating payment installments</p>
              <a href="/crm/payments/create/" class="btn btn-secondary btn-sm border">
                <i class="fas fa-plus me-2"></i>Create Payment
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Upcoming Payments -->
    <div class="col-lg-6 col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header pb-0 p-3 border-bottom">
          <div class="row">
            <div class="col-6">
              <h6 class="mb-0 text-dark">Upcoming Payments</h6>
            </div>
            <div class="col-6 text-end">
              <a class="btn btn-link text-dark px-3 mb-0" href="/crm/payments/">
                <i class="fas fa-list text-xs me-1"></i>View All
              </a>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          {% if upcoming_payments %}
            <div class="table-responsive">
              <table class="table align-items-center mb-0">
                <thead>
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Project</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Client</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Amount</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Due Date</th>
                  </tr>
                </thead>
                <tbody>
                  {% for payment in upcoming_payments %}
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0 text-sm text-dark">{{ payment.project.title|truncatechars:25 }}</h6>
                        </div>
                      </div>
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0 text-dark">{{ payment.project.client.name }}</p>
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0 text-warning">₹{{ payment.amount }}</p>
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0 text-dark">{{ payment.paid_date|date:"M d, Y" }}</p>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="ni ni-time-alarm text-secondary text-gradient text-lg opacity-10 mb-3" style="font-size: 3rem;"></i>
              <h6 class="text-secondary mb-2">No upcoming payments</h6>
              <p class="text-secondary mb-3">All payments are up to date</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  var ctx = document.getElementById('income-chart').getContext('2d');
  
  // Use real data from Django backend
  var monthLabels = {{ month_labels|safe }};
  var incomeData = {{ monthly_income|safe }};
  
  // Fallback data if no real data exists
  if (!monthLabels || monthLabels.length === 0) {
    monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    incomeData = [0, 0, 0, 0, 0, 0];
  }
  
  var chartData = {
    labels: monthLabels,
    datasets: [{
      label: 'Monthly Income',
      data: incomeData,
      borderColor: '#6c757d',
      backgroundColor: 'rgba(108, 117, 125, 0.1)',
      tension: 0.4,
      fill: true
    }]
  };

  new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '₹' + value.toLocaleString();
            }
          }
        }
      }
    }
  });
});
</script>

{% endblock content %}
